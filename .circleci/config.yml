version: 2.1

commands:
  setup-executor:
    steps:
      - run:
          name: Setup executor
          command: |
            apt-get -qq update
            apt-get -q install -y git openssh-client curl ca-certificates make tar gzip
            bash <(curl -fsSL https://get.docker.com)
      - setup_remote_docker:
          docker_layer_caching: true

  checkout-all:
    steps:
      - checkout
      - run:
          name: Checkout submodules
          command: git submodule update --init --recursive

  setup-automation:
    steps:
      - run:
          name: Setup automation
          command: |
            git submodule update --init --recursive
            ./deps/readies/bin/getpy3
            docker login --username redisfab --password "$DOCKER_REDISFAB_PWD"

jobs:
  platform-builder:
    machine:
      enabled: true
      image: ubuntu-2004:202010-01
      resource_class: medium
    parameters:
      platforms:
        type: string
    steps:
      - checkout-all
      - run:
          name: Setup automation
          command: |
            sudo ./deps/readies/bin/getpy3
            sudo ./deps/readies/bin/getdocker --just-enable-exp
            docker version
            docker login --username redisfab --password "$DOCKER_REDISFAB_PWD"
      - run:
          name: Build and publish
          command: |
            cd rmbuilder
            for nick in <<parameters.platforms>>"; do
                sudo bash -l -c "make build X64=1 OSNICK=$nick"
                ../deps/readies/bin/sep
                if [[ $CIRCLE_BRANCH == master ]]; then
                    sudo bash -l -c "make publish X64=1 OSNICK=$nick"
                    ../deps/readies/bin/sep
                fi
            done
          no_output_timeout: 30m

  platform-builder-docker:
    docker:
      - image: debian:bullseye
    parameters:
      platform:
        type: string
    steps:
      - setup-executor
      - checkout-all
      - setup-automation
      - run:
          name: Build and publish
          command: |
            cd rmbuilder
            sudo bash -l -c "make build X64=1 OSNICK=<<parameters.platform>>"
            if [[ $CIRCLE_BRANCH == master ]]; then
                sudo bash -l -c "make publish X64=1 OSNICK=<<parameters.platform>>"
            fi
          no_output_timeout: 30m

#----------------------------------------------------------------------------------------------------------------------------------

on-any-branch: &on-any-branch
  filters:
    branches:
      only: /.*/
    tags:
      only: /.*/

never: &never
  filters:
    branches:
      ignore: /.*/
    tags:
      ignore: /.*/

on-master: &on-master
  filters:
    branches:
      only: master
    tags:
      ignore: /.*/

on-integ-branch: &on-integ-branch
  filters:
    branches:
      only:
        - master
        - /^\d+\.\d+.*$/
        - /^feature-.*$/
    tags:
      ignore: /.*/

not-on-integ-branch: &not-on-integ-branch
  filters:
    branches:
      ignore:
        - master
        - /^\d+\.\d+.*$/
        - /^feature-.*$/
    tags:
      ignore: /.*/

on-version-tags: &on-version-tags
  filters:
    branches:
      ignore: /.*/
    tags:
      only: /^v[0-9].*/

on-integ-and-version-tags: &on-integ-and-version-tags
  filters:
    branches:
      only:
        - master
        - /^\d+\.\d+.*$/
        - /^feature-.*$/
    tags:
      only: /^v[0-9].*/

#----------------------------------------------------------------------------------------------------------------------------------

workflows:
  version: 2
  build_all:
    jobs:
      - platform-builder:
          # name: builder
          <<: *not-on-integ-branch
          platforms: "bullseye"
          context: common
      - platform-builder:
          name: integ-platform-builder
          <<: *on-integ-branch
          platforms: "bullseye centos7 centos8 focal bionic xenial"
          context: common
  weekly:
    triggers:
      - schedule:
          # Run on Sundat 21:17 [M H DoM M DoW]
          cron: "21 17 * * 0"
          filters:
            branches:
              only: master
    jobs:
      - platform-builder:
          name: weekly-build
          platforms: "bullseye centos7 centos8 focal bionic xenial"
          context: common
